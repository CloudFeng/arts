# 《Linux性能优化实战》笔记

## 04&05|经常说的 CPU 上下文切换是什么意思？| 2020.05.30~2020.05.31

### 笔记与思考

#### 关键概念

1. CPU上下文切换
   - 什么是上下文：CPU在运行任何任务前必须知道任务从哪里加载（寄存器），又从哪里开始（PC）;
   - 什么是上下文切换：把之前一个任务的CPU上下文保存起来，然后加载新任务的CPU上下文，最后条钻到PC所指的新位置，开始新的任务。

1. 上下文切换有哪些类型

类型 | 描述
---------|----------
进程上下文切换 | 进程等待资源或者被其他优先级高强占或者时间片到了
线程上下文切换 | 分为两种：跨进程线程切换；同进程中线程切换
中断上下文切换 | 为了响应硬件事件而中断正在运行的任务

1. 如何去排查上下文切换带来性能问题

- `vmstat` 看正在运行的进程队列长度、上下文切换次数、中断次数;
- `pidstat` 看 自愿切换、非自愿切换还是中断次数多：
  > + 自愿上下文切换变多了，说明进程都在等待资源，有可能发生了 I/O 等其他问题；
  > + 非自愿上下文切换变多了，说明进程都在被强制调度，也就是都在争抢 CPU，说明 CPU 的确成了瓶颈；
  > + 中断次数变多了，说明 CPU 被中断处理程序占用，还需要通过查看 /proc/interrupts 文件来分析具体的中断类型。

4. 涉及到工具有哪些

工具名称 | 功能概述 | 案例
---------|----------|---------
`sysbench`|一个多线程的基准测试工具，一般用来评估不同系统参数下的数据库负载情况。|sysbench 来模拟系统多线程调度切换的情况:`sysbench --threads=10 --max-time=300 threads run`
`vmstat` | 用来分析系统的内存使用情况，也常用来分析 CPU 上下文切换和中断的次数 | `vmstat 1`
`pidstat` | 每个线程的上下文切换详情,注意里面：自愿切换&非自愿切换 | `pidstat -wt -u 1`
`/proc/interrupts` |了解中断类型和详情 | `watch -d cat /proc/interrupts`

5. 什么情况下的CPU上下文切换是异常的

平时CPU上下文的切换次数比较稳定：数百~一万，若切换次数超过一万或者切换次数数量级的增长。

思考：如何去做监控，`vmstat` ？

### 发现专栏金句

无

### 发现专栏精选留言

@小花 
进程切换我想到了很多年前在银行柜台办理业务的情形：

1.银行分配各个窗口给来办理业务的人
2.如果只有1个窗口开放（系统资源不足），大部分都得等
3.如果正在办理业务的突然说自己不办了（sleep）,那他就去旁边再想想（等）
4.如果突然来了个VIP客户，可以强行插队
5.如果突然断电了（中断），都得等。。

将上下文切换带来的系统开销用到生活就是，最好让自己大脑专注的做事情，不要不断的去切换任务。
不断的切换只会让自己的注意力分散、消耗殆尽，最后啥也没有做好。

编辑： 云枫 2020.05.31

---