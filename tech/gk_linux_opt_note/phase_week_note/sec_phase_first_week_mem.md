## 15|基础篇：Linux内存是怎么工作的？

### 笔记

1. 内存分配工作机制
   - 虚拟内存 `-->` 内存映射 `-->` 主存
   - 并不是所有的虚拟内存都会分配物理内存，只有那些实际使用的虚拟内存才分配物理内存，并且分配后的物理内存，是通过内存映射来管理的
2. 内存分配与回收
   - 内存分配：malloc-堆；mmap-文件映射;
   - 回收三种方式:
 
     + 回收缓存，比如使用 LRU（Least Recently Used）算法，回收最近使用最少的内存页面；
     + 回收不常访问的内存，把不常用的内存通过交换分区直接写到磁盘中；
     + 杀死进程，内存紧张时系统还会通过 OOM（Out of Memory），直接杀掉占用大量内存的进程。

### 发现面试题

1. 内存回收有几种方式

### 专栏金句
   无
### 发现专栏精选留言

@JohnT3e
手把手教你使用程序（C语言）来实际地去搞清楚虚拟内存分布: https://blog.holbertonschool.com/hack-the-virtual-memory-malloc-the-heap-the-program-break/


## 16|基础篇：怎么理解内存中的Buffer和Cache？

### 笔记

1. Buffers 是内核缓冲区用到的内存，对应的是 /proc/meminfo 中的 Buffers 值。
2. Cache 是内核页缓存和 
3. Slab 用到的内存，对应的是 /proc/meminfo 中的 Cached 与 SReclaimable 之和。
4. Buffer 是对磁盘数据的缓存，而 Cache 是文件数据的缓存，它们既会用在读请求中，也会用在写请求中。

### 发现面试题

  无

### 专栏金句

> 初学时不用非得理解所有内容，继续往后学，多理解相关的概念并配合一定的实践之后，再回头复习往往会容易不少。当然，基本功不容放弃。

> 强调通用思路和方法，而不是让你死记结论

> 在排查性能问题时，由于各种资源的性能指标太多，我们不可能记住所有指标的详细含义。那么，准确高效的手段——查文档，就非常重要了。你一定要养成查文档的习惯，并学会解读这些性能指标的详细含义。

### 发现专栏精选留言


## 17|案例篇：如何利用系统缓存优化程序的运行效率？

### 笔记

1. 衡量缓存使用好坏的指标：缓存的命中率。所谓缓存命中率，是指直接通过缓存获取数据的请求次数，占所有数据请求次数的百分比。命中率越高，表示使用缓存带来的收益越高，应用程序的性能也就越好。
2. 工具：
   - cachestat 提供了整个操作系统缓存的读写命中情况。
   - cachetop 提供了每个进程的缓存命中情况。
   - pcstat来查看文件在内存中的缓存大小以及缓存比例
   - dd 作为一个磁盘和文件的拷贝工具，经常被拿来测试磁盘或者文件系统的读写性能
   - strace：观察系统调用

### 发现面试题
   
   无

### 专栏金句

你想要做成某件事情，结果应该怎么评估？

### 发现专栏精选留言

无

## 18|案例篇：内存泄漏了，我该如何定位和处理？

### 笔记

1. 虚拟内存哪些部分会发生内存泄漏
  - 栈内存由系统自动分配和管理。一旦程序运行超出了这个局部变量的作用域，栈内存就会被系统自动回收，所以不会产生内存泄漏的问题。
  - 堆内存由应用程序自己来分配和管理。除非程序退出，这些堆内存并不会被系统自动释放，而是需要应用程序明确调用库函数 free() 来释放它们。如果应用程序没有正确释放堆内存，就会造成内存泄漏。
  - 只读段，包括程序的代码和常量，由于是只读的，不会再去分配新的内存，所以也不会产生内存泄漏。
  - 数据段，包括全局变量和静态变量，这些变量在定义时就已经确定了大小，所以也不会产生内存泄漏。
  - 内存映射段，包括动态链接库和共享内存，其中共享内存由程序动态分配和管理。所以，如果程序在分配后忘了回收，就会导致跟堆内存类似的泄漏问题。
2. 工具
   - memleak 可以跟踪系统或指定进程的内存分配、释放请求，然后定期输出一个未释放内存和相应调用栈的汇总情况（默认 5 秒）。
  
### 发现面试题

你是如何定位内存泄漏的？

### 专栏金句

为了避免内存泄漏，最重要的一点就是养成良好的编程习惯，比如分配内存后，一定要先写好内存释放的代码，再去开发其他逻辑。还是那句话，有借有还，才能高效运转，再借不难。

### 发现专栏精选留言

## 19&20|案例篇：为什么系统的Swap变高了

### 笔记
1. Swap原理
   + 把一块磁盘空间或者一个本地文件（以下讲解以磁盘为例），当成内存来使用。它包括换出和换入两个过程。
     - 换出，就是把进程暂时不用的内存数据存储到磁盘中，并释放这些数据占用的内存。
     - 换入，则是在进程再次访问这些内存的时候，把它们从磁盘读到内存中来。
   + 调整 Swap 积极程度的权重：/proc/sys/vm/swappiness，设置为0，当剩余内存 + 文件页小于页高阈值时，还是会发生Swap。
   + 类型：Swap 分区和 Swap 文件。
   + 降低swap的方式
    + 禁止 Swap，现在服务器的内存足够大，所以除非有必要，禁用 Swap 就可以了。随着云计算的普及，大部分云平台中的虚拟机都默认禁止 Swap。
    + 如果实在需要用到 Swap，可以尝试降低 swappiness 的值，减少内存回收时 Swap 的使用倾向。
    + 响应延迟敏感的应用，如果它们可能在开启 Swap 的服务器中运行，你还可以用库函数 mlock() 或者 mlockall() 锁定内存，阻止它们的内存换出。
2. 内存回收方式
- 直接内存回收
- 内核定期回收：三个阀值，通过`/proc/sys/vm/min_free_kbytes`设置最小，其他的两个可以计算出来：
   + `pages_low = pages_min*5/4`
   + `pages_high = pages_min*3/2`

### 发现面试题

如何排查Swap变高？
1. 看总体情况：`free`
2. 看Swap变化情况：`sar -r -S 1`
3. 观察剩余内存、内存阈值以及匿名页和文件页的活跃情况: `watch -d grep -A 15 'Normal' /proc/zoneinfo`
4. 查看进程 Swap 换出的虚拟内存大小:`for file in /proc/*/status ; do awk '/VmSwap|Name|^Pid/{printf $2 " " $3}END{ print ""}' $file; done | sort -k 3 -n -r | head`

### 专栏金句
  无
### 发现专栏精选留言
   无


## 21|套路篇：如何“快准狠”找到系统内存的问题？

### 笔记

1. 分析思路
- 先用 free 和 top，查看系统整体的内存使用情况。
- 再用 vmstat 和 pidstat，查看一段时间的趋势，从而判断出内存问题的类型。
- 最后进行详细分析，比如内存分配分析、缓存 / 缓冲区分析、具体进程的内存使用分析等。


### 发现面试题

有哪些内存调优方法?
大原则：内存调优最重要的就是，保证应用程序的热点数据放到内存中，并尽量减少换页和交换。

1. 最好禁止 Swap。如果必须开启 Swap，降低 swappiness 的值，减少内存回收时 Swap 的使用倾向。
2. 减少内存的动态分配。比如，可以使用内存池、大页（HugePage）等。
3. 尽量使用缓存和缓冲区来访问数据。比如，可以使用堆栈明确声明内存空间，来存储需要缓存的数据；或者用 Redis 这类的外部缓存组件，优化数据的访问。
4. 使用 cgroups 等方式限制进程的内存使用情况。这样，可以确保系统内存不会被异常进程耗尽。
5. 通过 /proc/pid/oom_adj ，调整核心应用的 oom_score。这样，可以保证即使内存紧张，核心应用也不会被 OOM 杀死。

### 专栏金句

无

### 发现专栏精选留言


## 22|答疑（三）：文件系统与磁盘的区别是什么？

### 笔记

读这篇专栏最大感受就是，检查自己是否理解透知识点。学习如何回答问题。


### 发现面试题
  
  无

### 专栏金句

在学习时，最好先用最新的系统和工具，它们可以为你提供更简单直观的结果，帮你更好的理解系统的原理。

在你掌握了这些原理后，回过头来，再去理解旧版本系统中的工具和原理，你会发现，即便旧版本中的很多工具并不是那么好用，但是原理和指标是类似的，你依然可以轻松掌握它们的使用方法。

### 发现专栏精选留言

无