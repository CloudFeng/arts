# 《Linux性能优化实战》笔记

## 09&10|软中断&如何排查软中断引起的性能问题

### 笔记

#### 中断

1. 什么是中断
中断是系统用来响应硬件设备请求的一种机制，它会打断进程的正常调度和执行，然后调用内核中的中断处理
程序来响应设备的请求。
2. 中断作用是什么
中断其实是一种异步的事件处理机制，可以提高系统的并发处理能力。
3. 中断存在问题
  
- 中断处理程序执行过长：影响正常进程运行调度，从降低并发处理能力；
- 中断丢失的问题：中断处理程序在响应中断时，还会临时关闭中断。

#### Linux中断处理过程

  为了解决中断处理程序执行过长和中断丢失的问题，Linux 将中断处理过程分成了两个阶段:

阶段| 说明 | 特点| 查看
---------|----------|---------|---------
 硬中断 |上半部用来快速处理中断，它在中断禁止模式下运行，主要处理跟硬件紧密相关的或时间敏感的工作| 打断CPU正在执行的任务，快速执行中断处理程序|`cat /proc/interrupts`
 软中断 |下半部用来延迟处理上半部未完成的工作，通常以**内核线程**的方式运行|延迟执行，以内核线程的方式执行，并且每个CPU对应一个软中断线程：ksoftirqd/CPU编号;包括：网络收发、定时、调度、RCU 锁|1.总体：`cat /proc/softirqs`;2.具体线程：`ps aux | grep softirq`【注意里面的10中中断类型，以及不同CPU之间的差异】

#### 软中断引起的性能排查思路

文中作者给出的网络的软中断引起的问题，所以做一个总结。步骤1和步骤2是通用的，步骤3和步骤4是在网络中断
有问题情况下才去排查。

步骤|目的|注意
----|-----|------
1.`top`,top运行后按数字`1`切换到显示所有CPU|查看系统的整体运行情况，以及占用CPU最高的进程或者上下文切换或者其他的情况|无 
2.`watch -d cat /proc/softirqs`|中断次数的变化速率|`/proc/softirqs` 是一个累积的情况，需要看趋势; 若确定是NET_TX或NET_RX 转步骤 3 
3.`sar -n DEV`|查看网络收发情况 - 网络收发吞吐量（BPS：每秒收发的字节数）、PPS：每秒收发的网络帧数|1.PPS:rxpck/s 和 txpck/s 分别表示每秒接收、发送的网络帧数2.BPS：rxkB/s 和 txkB/s 分别表示每秒接收、发送的千字节数 3.注意观察收发是否存在差异 4.计算每帧大小：`BPS*1024/PPS`
4.`tcpdump -i eth0 -n tcp port 80`|查看网络包的情况|注意观察是否存在大量的`SYN``或者TIME_WAIT、CLOSE_WAIT`

### 发现专栏中金句

取外卖例子，特别棒。

### 发现面试题

如何查看软中断，`/proc/softirqs`是累积中断吗?

编辑：云枫 2020.06.01~2020.06.02

## 11|套路篇：如何迅速分析出系统CPU的瓶颈在哪里?

### 笔记

看了一段时间的专栏的内容，CPU指标不多，但是排查工具何其多。面对真实的CPU性能瓶颈问题，如何选择工具去分析，头脑是乱的，没有一个依据。看到此篇刚好解决心中的疑惑，心中又有另外的疑问了，为啥作者能够整理出来呢。

1. CPU指标对应的工具
![](../image/cpu_index_tool.png)
2. 工具对应的指标
![](../image/cpu_tool_index.png)
3. 3个核心工具排查CPU性能瓶颈
![](../image/3_core_tool.png)

### 发现专栏中金句

   无

### 发现面试题

你是如何利用有限工具定位CPU性能瓶颈：`top`、`pidstat` 和 `vmstat`？


## 12|CPU性能优化的几个思路

### 笔记

步骤|描述|详细|注意事项
----|----|-----|--------
1.如何量化性能|如何判断性能优化是不是有效的？特别是优化后，到底能提升多少性能呢？|1.确定性能的量化指标；2. 测试优化前的性能指标；3. 测试优化后的性能指标。|不要局限在单一维度的指标上，你至少要从应用程序和系统资源这两个维度，分别选择不同的指标；
2.选择哪个问题进行优化|性能问题通常不是独立的，如果有多个性能问题同时发生，你应该先优化哪一个呢|1. 2/8原则	|动手优化之前先动脑，先把所有这些性能问题给分析一遍，找出最重要的、可以最大程度提升性能的问题，从它开始优化。
3.选择何种优化方案|	提升性能的方法并不是唯一的，当有多种方法可以选择时，你会选用哪一种呢？是不是总选那个最大程度提升性能的方法就行了呢？|在考虑选哪个性能优化方法时，你要综合多方面的因素【什么因素？】。|切记，不要想着“一步登天”，试图一次性解决所有问题；也不要只会“拿来主义”，把其他应用的优化方法原封不动拿来用，却不经过任何思考和分析。

## 发现面试题

### 怎么理解过早优化是万恶之源

1. 优化会带来复杂性的提升，降低可维护性；
2. 需求不是一成不变的。针对当前情况进行的优化，很可能并不适应快速变化的新需求。这样，在新需求出现时，这些复杂的优化，反而可能阻碍新功能的开发
3. 性能优化最好是逐步完善，动态进行，不追求一步到位，而要首先保证能满足当前的性能要求。当发现性能不满足要求或者出现性能瓶颈时，再根据性能评估的结果，选择最重要的性能问题进行优化。

### 如何降低CPU的使用率，提高CPU的并行处理能力

提示：从应用程序优化和系统优化两个维度考虑。

## 13&14|CPU性能答疑篇

这两讲都作者将评论中学员遇到的问题，进行统计并集中回答。两篇中最为感触的比价深就是，学习专栏的核心是学习分析思路。
学习性能优化，需要啃硬骨头，坚持下去。

>掌握整体的分析思路，才是我们首先要做的。因为，性能优化的原理和思路，在任何编程语言中都是相通的。

>如果你想成为高手，辛苦和坚持都是不可避免的。所以，希望你在查看这些资料时，不要一遇到不懂的就打退堂鼓。任何东西的第一遍学习有不懂的地方很正常，忍住恐惧别放弃，继续往后走，前面很多问题可能会一并解决掉，再看第二遍、第三遍就更轻松了。还是那句话，抓住主线不动摇，先从最基本的原理开始，掌握性能分析的思路，然后再逐步深入，探究细节，不要试图一口吃成个大胖子。

编辑： 云枫 2020.06.03~06.06

---